<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VC-VCCU VDV261 Configurator | Web Serial Standalone</title>
    <style>
        :root {
            /* Default Dark Theme Variables (Expert Mode) */
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #4b5563;
        }

        /* Light Theme Overrides (User Mode) */
        body.theme-light {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #f9fafb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Layout */
        .container {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            min-width: 500px;
            transition: all 0.3s ease;
        }

        /* Full width for User mode */
        body.theme-light .left-panel {
            max-width: 100%;
            margin: 0;
        }

        .right-panel {
            width: 450px;
            display: flex;
            flex-direction: column;
            background-color: #000; /* Always keep logs dark */
            color: #f3f4f6; /* Force light text for logs */
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: width 0.3s ease, opacity 0.3s ease;
        }

        /* Components */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: background 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--error); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success); }
        .btn-secondary { background-color: var(--bg-input); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background-color: var(--border); }
        .btn:disabled { background-color: var(--border); cursor: not-allowed; opacity: 0.7; }
        .w-full { width: 100%; }
        .flex-row { display: flex; gap: 10px; }

        /* Inputs */
        input, select, textarea {
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px;
            font-family: monospace;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        label { font-size: 0.85rem; color: var(--text-muted); font-weight: bold; display: block; margin-top: 10px; }
        
        input[type="file"] {
            font-size: 0.8rem;
            padding: 4px;
        }

        /* Tabs */
        .tabs { display: flex; background: var(--bg-input); border-radius: 6px; padding: 4px; border: 1px solid var(--border); width: fit-content; }
        .tab { padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; color: var(--text-muted); }
        .tab.active { background-color: var(--bg-card); color: var(--text-main); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        /* In light mode, active tab needs distinction */
        body.theme-light .tab.active { background-color: #fff; color: var(--primary); }

        /* Status Bar */
        .status-bar {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        .status-connected { background-color: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .status-disconnected { background-color: rgba(239, 68, 68, 0.2); color: var(--error); border: 1px solid var(--error); }
        .status-warning { background-color: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }

        /* Dropzone */
        .dropzone {
            border: 2px dashed var(--border);
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dropzone:hover, .dropzone.drag-over { background-color: var(--bg-input); border-color: var(--primary); }
        .dropzone.has-file { border-color: var(--success); background-color: rgba(16, 185, 129, 0.1); }

        /* Config Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            background-color: var(--bg-input);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        .info-item { display: flex; flex-direction: column; }
        
        .info-label { 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            margin-bottom: 4px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: normal; 
        }
        
        .info-value { 
            font-weight: bold; 
            font-size: 1rem; 
            color: var(--text-main); 
            word-break: break-all; 
        }

        /* Logs */
        .log-header { padding: 8px 10px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .log-content { flex: 1; overflow-y: auto; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; }
        .log-entry { margin-bottom: 4px; word-break: break-all; }
        .log-time { color: #555; margin-right: 8px; font-size: 11px; }
        .text-info { color: #67e8f9; }
        .text-success { color: #4ade80; }
        .text-error { color: #f87171; }
        .text-warning { color: #facc15; }
        .text-debug { color: #9ca3af; font-size: 0.9em; }

        /* Small header buttons */
        .btn-header { padding: 4px 10px; font-size: 0.75rem; margin-left: 5px; border-radius: 4px; }
        .btn-toggle-off { background-color: #374151; color: #9ca3af; border: 1px solid #4b5563; }
        .btn-toggle-on { background-color: #f59e0b; color: #000; border: 1px solid #d97706; font-weight: bold; }

        /* Steps */
        .step-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .step-icon { width: 24px; text-align: center; margin-right: 10px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        .step-label { color: var(--text-muted); font-size: 0.9rem; }
        
        /* Status Colors */
        .step-success .step-label { color: var(--success); }
        .step-success .step-icon { color: var(--success); }
        
        .step-error .step-label { color: var(--error); }
        .step-error .step-icon { color: var(--error); } /* Cross in Red */

        /* In light mode, loading text should be dark/primary, not white */
        .step-loading .step-label { color: var(--primary); font-weight: bold; } 
        
        /* Modern Spinner */
        .spinner { 
            display: inline-block;
            width: 18px; 
            height: 18px; 
            border: 2px solid rgba(59, 130, 246, 0.2); 
            border-top-color: var(--primary); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* User Layout - Side by Side */
        .user-grid-layout { display: flex; gap: 30px; align-items: flex-start; }
        .col-config { flex: 1; min-width: 0; }
        .col-steps { flex: 1; min-width: 0; border-left: 1px solid var(--border); padding-left: 30px; }
        .col-steps h3 { margin-top: 0; font-size: 1rem; color: var(--text-muted); margin-bottom: 15px; }

        /* Manual Input Box */
        .manual-input-box {
            background-color: var(--bg-card);
            border: 1px solid var(--primary);
            border-left-width: 4px;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        .modal-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
            text-align: center;
            color: var(--text-main);
        }
        /* PDF specific styles */
        #pdf-content {
            padding: 20px;
        }
        
        .modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; margin-top: 0; }
        /* Renamed modal-body to pdf-content for targeting with html2canvas */
        .modal-pdf-content { text-align: left; background: var(--bg-input); padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; border: 1px solid var(--border); }
        
        .verify-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .verify-row:last-child { border-bottom: none; }
        .verify-label { font-weight: 600; color: var(--text-muted); }
        .verify-val { color: var(--text-main); word-break: break-all; text-align: right; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Responsive */
        @media (max-width: 1000px) {
            .container { flex-direction: column; height: auto; }
            .right-panel { width: 100%; height: 400px; }
            body { height: auto; overflow-y: auto; }
            
            .user-grid-layout { flex-direction: column; }
            .col-steps { border-left: none; padding-left: 0; border-top: 1px solid var(--border); padding-top: 30px; width: 100%; }
        }
    </style>
    <!-- FIX POUR L'EXPORT PDF: Utiliser des CDN garantit la disponibilit√© et le cache pour l'autonomie hors ligne. -->
    <!-- html2canvas removed as we now use vector generation for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="theme-light"> <!-- Default to Light since User is default -->

    <div class="header card">
        <div>
            <h1>VC-VCCU VDV261 Configurator</h1>
            <span style="font-size: 0.8rem; color: var(--text-muted);">USB Serial Interface</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="tabs">
                <div class="tab active" id="tab-user" onclick="switchTab('user')">User</div>
                <div class="tab" id="tab-expert" onclick="switchTab('expert')">Expert</div>
            </div>
            <button id="btn-connect" class="btn btn-primary" onclick="toggleConnection()">üîå Connect Device</button>
        </div>
    </div>

    <div id="status-display" class="status-bar status-disconnected">
        Waiting for connection...
    </div>

    <div class="container">
        <!-- LEFT PANEL: CONTROLS -->
        <div class="left-panel">
            
            <!-- USER MODE -->
            <div id="view-user" class="card">
                <h2>USER Mode : Configuration installation</h2>
                
                <div class="user-grid-layout">
                    <!-- Config Section (Left) -->
                    <div class="col-config">
                        <div id="dropzone" class="dropzone" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFile(this.files[0])">
                            <p id="drop-text" style="margin: 0; color: var(--text-muted);">Click or Drag & Drop JSON Config Here</p>
                        </div>

                        <div id="config-info" style="display: none; margin-top: 20px;">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Customer:</span>
                                    <span id="val-customer" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Charger:</span>
                                    <span id="val-charger" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Backend:</span>
                                    <span id="val-backend" class="info-value">-</span>
                                </div>
                            </div>
                            
                            <label>Select VIN</label>
                            <select id="vin-select" onchange="toggleManualVin()"></select>

                            <!-- Manual Entry Container -->
                            <div id="manual-vin-container" class="manual-input-box" style="display: none;">
                                <label style="margin-top:0;">Manual VIN</label>
                                <input id="manual-vin" type="text" placeholder="Enter VIN (e.g. WBA...)">
                                <label>Password (optional)</label>
                                <input id="manual-pass" type="text" placeholder="Enter Password">
                            </div>
                        </div>
                    </div>

                    <!-- Steps Section (Right) -->
                    <div class="col-steps">
                        <!-- BUTTON MOVED HERE -->
                        <button id="btn-run-user" class="btn btn-primary w-full" style="display:none; margin-bottom: 20px; font-size: 1.1rem;" onclick="runWizardSequence()" disabled>
                            Install Configuration
                        </button>

                        <h3>Installation Status <span id="display-sn" style="font-size:0.9rem; color:var(--primary); margin-left:10px;"></span></h3>
                        <div id="wizard-steps">
                            <!-- Steps injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPERT MODE -->
            <div id="view-expert" class="card" style="display: none;">
                <h2>Expert Mode</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="margin-top:0;">1. Diagnostics</label>
                    <div class="flex-row">
                        <button class="btn btn-secondary" onclick="sendAction('identify')">Identify Device</button>
                        <button class="btn btn-secondary" onclick="sendAction('test_can')">Test CAN (SN)</button>
                        <button class="btn btn-secondary" onclick="sendAction('start_session')">Start Session</button>
                        <button class="btn btn-secondary" onclick="sendAction('request_seed')">Unlock Security</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px; border-top: 1px solid var(--border); padding-top: 10px;">
                    <label>2. Certificates</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>V2G (FD0D)</label>
                            <!-- ADDED: File Input for Cert 1 -->
                            <input type="file" id="certFile1" accept=".pem,.crt,.der" style="margin-bottom:5px;">
                            <textarea id="exp-c1" placeholder="Paste Hex..." style="height: 60px;"></textarea>
                            <button class="btn btn-secondary w-full" onclick="sendExpCert(1)">Write Cert 1</button>
                        </div>
                        <div>
                            <label>VAS (FD12)</label>
                            <!-- ADDED: File Input for Cert 2 -->
                            <input type="file" id="certFile2" accept=".pem,.crt,.der" style="margin-bottom:5px;">
                            <textarea id="exp-c2" placeholder="Paste Hex..." style="height: 60px;"></textarea>
                            <button class="btn btn-secondary w-full" onclick="sendExpCert(2)">Write Cert 2</button>
                        </div>
                    </div>
                </div>

                <div style="border-top: 1px solid var(--border); padding-top: 10px;">
                    <label>3. VAS Config</label>
                    <div class="flex-row" style="margin-bottom: 10px;">
                        <button class="btn btn-success" style="flex:1;" onclick="sendAction('activate_tls', {enabled: true})">Enable TLS</button>
                        <button class="btn btn-danger" style="flex:1;" onclick="sendAction('activate_tls', {enabled: false})">Disable TLS</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                        <div>
                            <label>Type</label>
                            <select id="exp-vas-type"><option value="1">IPv6</option><option value="2" selected>URL</option></select>
                        </div>
                        <div><label>URL / IP</label><input id="exp-vas-url"></div>
                    </div>
                    <label>Path</label><input id="exp-vas-path">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><label>User</label><input id="exp-vas-user"></div>
                        <div><label>Pass</label><input id="exp-vas-pass"></div>
                    </div>
                    <button class="btn btn-primary w-full" style="margin-top: 15px;" onclick="writeExpVas()">Write VAS Config</button>
                    <button class="btn btn-secondary w-full" style="margin-top: 10px;" onclick="sendAction('read_config')">Read Current Config</button>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: LOGS (Hidden in User Mode) -->
        <div class="right-panel" id="right-panel">
            <div class="log-header">
                <span style="color: #888; font-size: 0.8rem; font-weight: bold;">SERIAL CONSOLE</span>
                <div>
                     <!-- Toggle Button -->
                    <button id="btn-toggle-logs" class="btn btn-header btn-toggle-off" onclick="toggleDebugLogs()">LOGS: OFF</button>
                    <button class="btn btn-danger btn-header" onclick="clearLogs()">CLR</button>
                </div>
            </div>
            <div id="log-container" class="log-content">
                <div style="text-align: center; color: #444; margin-top: 20px;">Not Connected</div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Success Modal -->
    <div id="success-modal" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
            <h2 class="modal-title" style="color: var(--success);">Success!</h2>
            <p style="color: var(--text-muted);">Configuration applied and verified successfully.</p>
            
            <!-- Target for PDF Export -->
            <div id="pdf-content" class="modal-pdf-content">
                <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary);">Final Verification Report</div>
                <div id="verify-content">
                    <!-- Filled by JS -->
                </div>
                <div style="margin-top: 20px; font-size: 0.8rem; color: var(--text-muted); text-align: right;">
                    Generated on: <span id="generation-date"></span>
                </div>
            </div>
            
            <div class="flex-row" style="margin-top: 20px;">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeModal('success-modal')">Close</button>
                <button class="btn btn-success" style="flex:1;" onclick="exportPdfReport()">Export PDF</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h2 class="modal-title" style="color: var(--error);">Operation Failed</h2>
            <p id="error-msg" style="color: var(--text-muted);">The sequence stopped due to an error.</p>
            
            <div class="modal-body">
                <ul style="margin: 0; padding-left: 20px; color: var(--text-muted);">
                    <li>Check physical connections (CAN H/L inverted)</li>
                    <li>Ensure 24V power supply is ON</li>
                </ul>
            </div>
            
            <button class="btn btn-danger w-full" onclick="closeModal('error-modal')">Close</button>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- State ---
        let port = null;
        let reader = null;
        let writer = null;
        let keepReading = false;
        let configData = null;
        let lastEvent = null; // Store last structured event from FW
        let handshakeInterval = null; // To manage retries during boot
        let debugLogsEnabled = false;
        // Stores the serial number (SN) and other verification data
        let currentVerificationData = { clientName: '', vin: '', sn: '' }; 

        // --- Constants ---
        const STEPS = [
            { id: 'sn', label: 'Connection Check & SN' },
            { id: 'session', label: 'Start Diagnostic Session' },
            { id: 'security', label: 'Security Access' },
            { id: 'cert1', label: 'Write V2G Certificate' },
            { id: 'cert2', label: 'Write V2ICP Certificate' },
            { id: 'tls', label: 'Enable/Disable TLS' },
            { id: 'vas', label: 'Write VAS Configuration' },
            { id: 'verify', label: 'Final Verification' }
        ];

        // --- Initialization ---
        window.onload = () => {
            renderSteps();
            // Start in User Mode (Light)
            switchTab('user');
            
            // Init Drag & Drop events (User Mode)
            const dropzone = document.getElementById('dropzone');
            dropzone.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropzone.classList.add('drag-over'); 
            });
            dropzone.addEventListener('dragleave', () => { 
                dropzone.classList.remove('drag-over'); 
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            // Init Cert Import events (Expert Mode)
            setupCertImport('certFile1', 'exp-c1');
            setupCertImport('certFile2', 'exp-c2');

            // Check Web Serial Support
            if (!navigator.serial) {
                // Modified alert to custom modal/message box as per instructions
                const status = document.getElementById('status-display');
                status.textContent = "Web Serial API not supported. Please use Chrome, Edge or Opera.";
                status.classList.remove('status-disconnected');
                status.classList.add('status-error');
            }
        };

        // --- Tab Switching ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Toggle Views
            document.getElementById('view-user').style.display = tab === 'user' ? 'block' : 'none';
            document.getElementById('view-expert').style.display = tab === 'expert' ? 'block' : 'none';

            // Toggle Right Panel (Logs) & Theme
            const rightPanel = document.getElementById('right-panel');
            
            if (tab === 'user') {
                document.body.classList.add('theme-light');
                rightPanel.style.display = 'none'; // Hide console
            } else {
                document.body.classList.remove('theme-light');
                rightPanel.style.display = 'flex'; // Show console
            }
        }

        // --- Serial Management ---
        async function toggleConnection() {
            if (port) {
                await disconnect();
            } else {
                await connect();
            }
        }

        async function connect() {
            try {
                // Request port (optionally filter if you knew the Vendor ID)
                // port = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x10c4 }] }); 
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                keepReading = true;
                readLoop();
                
                // Setup Writer
                const textEncoder = new TextEncoderStream();
                textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();

                updateUIState(true);
                addLog('Port Opened', 'success');

                // HANDSHAKE LOOP: Send identify every 1s until response or timeout
                // ESP32 resets on connection (DTR), taking ~3s to boot.
                let attempts = 0;
                handshakeInterval = setInterval(() => {
                    if (attempts >= 5) { // Timeout after 5 seconds
                        clearInterval(handshakeInterval);
                        if (document.getElementById('status-display').textContent.includes("Verifying")) {
                            addLog("Handshake Timeout. ESP32 Firmware updated? Or wrong port?", 'warning');
                            const st = document.getElementById('status-display');
                            st.textContent = "CONNECTED (Unknown Device - Select another one)";
                            st.classList.remove('status-connected');
                            st.classList.add('status-warning');
                        }
                        return;
                    }
                    sendAction('identify');
                    attempts++;
                }, 1000);

            } catch (err) {
                console.error(err);
                addLog('Connection Failed: ' + err.message, 'error');
            }
        }

        async function disconnect() {
            try {
                if (handshakeInterval) clearInterval(handshakeInterval);
                keepReading = false;
                if (reader) {
                    await reader.cancel().catch(() => {}); // Ignore cancel error
                }
                if (writer) {
                    await writer.close().catch(() => {}); // Ignore close error
                }
                if (port) {
                    await port.close().catch(() => {}); // Ignore port close error
                }
            } catch (e) {
                console.error("Disconnect Error:", e);
            } finally {
                port = null;
                reader = null;
                writer = null;
                updateUIState(false);
                addLog('Port Closed', 'warning');
            }
        }

        function updateUIState(connected) {
            const btn = document.getElementById('btn-connect');
            const status = document.getElementById('status-display');
            
            if (connected) {
                btn.textContent = "Disconnect";
                btn.classList.replace('btn-primary', 'btn-danger');
                status.textContent = "CONNECTED (Verifying...)";
                status.classList.remove('status-disconnected', 'status-warning');
                status.classList.add('status-connected');
                if (configData) document.getElementById('btn-run-user').disabled = false;
            } else {
                btn.textContent = "üîå Connect Device";
                btn.classList.replace('btn-danger', 'btn-primary');
                status.textContent = "Waiting for connection...";
                status.classList.remove('status-connected', 'status-warning');
                status.classList.add('status-disconnected');
                document.getElementById('btn-run-user').disabled = true;
            }
        }

        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            let buffer = '';

            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line
                        lines.forEach(processLine);
                    }
                }
            } catch (error) {
                addLog('Read Error: ' + error, 'error');
            } finally {
                reader.releaseLock();
            }
        }

        function processLine(line) {
            line = line.trim();
            if (!line) return;

            // Try parse JSON
            if (line.startsWith('{')) {
                try {
                    const msg = JSON.parse(line);
                    if (msg.type === 'log') {
                        // Detect if this is a raw hex log to color it gray
                        let type = 'info';
                        if (msg.content.startsWith('RX') || msg.content.startsWith('TX') || msg.content.startsWith('Flow')) {
                            type = 'debug';
                        }
                        addLog(stripTags(msg.content), type);
                    } else if (msg.type === 'event') {
                        lastEvent = msg;
                        console.log("Event RX:", msg); // DEBUG LOG
                        addLog(`EVENT [${msg.name}]: ${msg.status}`, msg.status === 'ok' ? 'success' : 'error');
                        // ADDED: Log the decoded data content in the logs
                        if (msg.data) {
                            addLog('DATA: ' + JSON.stringify(msg.data, null, 2), 'info');
                        }
                    } else if (msg.type === 'identity') {
                        // IDENTITY RECEIVED -> Stop Handshake
                        if (handshakeInterval) clearInterval(handshakeInterval);
                        addLog("IDENTIFIED: " + msg.id, 'success');
                        const st = document.getElementById('status-display');
                        st.textContent = "CONNECTED: " + msg.id;
                        st.classList.replace('status-warning', 'status-connected');
                    } else if (msg.type === 'ui_update') {
                        addLog(stripTags(msg.content));
                    } else {
                        addLog(line); // Unknown JSON
                    }
                } catch (e) {
                    addLog(line); // Failed JSON parse
                }
            } else {
                addLog(line); // Raw text (e.g. Boot logs)
            }
        }

        async function sendAction(action, data = {}) {
            if (!writer) {
                addLog("Cannot send: Not connected", 'error');
                return;
            }
            const payload = JSON.stringify({ action, ...data }) + '\n';
            try {
                await writer.write(payload);
                addLog(`-> TX: ${action}`, 'info');
            } catch (e) {
                addLog(`Send Error: ${e}`, 'error');
            }
        }

        // --- Log UI ---
        function addLog(msg, type = 'info') {
            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString();
            let colorClass = 'text-info';
            if (type === 'success') colorClass = 'text-success';
            if (type === 'error') colorClass = 'text-error';
            if (type === 'warning') colorClass = 'text-warning';
            if (type === 'debug') colorClass = 'text-debug';
            
            // Auto-detect type keywords if generic
            if (type === 'info') {
                if (msg.includes('Error') || msg.includes('√âchec')) colorClass = 'text-error';
                if (msg.includes('Succ√®s') || msg.includes('OK')) colorClass = 'text-success';
            }
            
            // Preserve whitespace for JSON printing
            const style = msg.startsWith('DATA:') ? 'white-space: pre-wrap;' : '';

            div.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}" style="${style}">${msg}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }

        function stripTags(html) {
            const div = document.createElement("div");
            div.innerHTML = html;
            return div.textContent || div.innerText || "";
        }
        
        // --- Debug Log Toggle ---
        function toggleDebugLogs() {
            debugLogsEnabled = !debugLogsEnabled;
            const btn = document.getElementById('btn-toggle-logs');
            if (debugLogsEnabled) {
                btn.textContent = "LOGS: ON";
                btn.classList.replace('btn-toggle-off', 'btn-toggle-on');
                sendAction('set_logging', { enabled: true });
            } else {
                btn.textContent = "LOGS: OFF";
                btn.classList.replace('btn-toggle-on', 'btn-toggle-off');
                sendAction('set_logging', { enabled: false });
            }
        }

        // --- File Handling (User Mode) ---
        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    configData = JSON.parse(e.target.result);
                    displayConfig();
                } catch (err) {
                    // Modified alert to console.error + log
                    console.error('Invalid JSON file:', err);
                    addLog('Fichier JSON invalide', 'error');
                }
            };
            reader.readAsText(file);
        }

        function displayConfig() {
            document.getElementById('drop-text').textContent = "Config Loaded: " + (configData.client || "Unknown");
            document.getElementById('dropzone').classList.add('has-file');
            document.getElementById('config-info').style.display = 'block';
            document.getElementById('btn-run-user').style.display = 'block'; // Show Button
            
            // Updated to new Grid Layout and Labels
            document.getElementById('val-customer').textContent = configData.client || '-';
            document.getElementById('val-charger').textContent = configData.chargeur || '-';
            document.getElementById('val-backend').textContent = configData.supervision || '-';
            // Removed TLS display logic here

            const sel = document.getElementById('vin-select');
            sel.innerHTML = '';
            
            // Add JSON list
            if (configData.user_list) {
                configData.user_list.forEach((u, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = u.vin;
                    sel.appendChild(opt);
                });
            }

            // Add Manual Option
            const manualOpt = document.createElement('option');
            manualOpt.value = 'manual';
            manualOpt.textContent = "Use a VIN that is not on the list";
            sel.appendChild(manualOpt);

            // Initialize correct state for inputs
            toggleManualVin();

            if (port) document.getElementById('btn-run-user').disabled = false;
            resetSteps();
        }

        function toggleManualVin() {
            const val = document.getElementById('vin-select').value;
            const manualBox = document.getElementById('manual-vin-container');
            if (val === 'manual') {
                manualBox.style.display = 'block';
            } else {
                manualBox.style.display = 'none';
            }
        }

        // --- Cert Handling (Expert Mode) ---
        // Converts ArrayBuffer to HEX String
        function arrayBufferToHex(buffer) {
            const bytes = new Uint8Array(buffer);
            return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("").toUpperCase();
        }

        // Setup listener for file inputs in Expert Mode
        function setupCertImport(inputId, textAreaId) {
            const fileInput = document.getElementById(inputId);
            fileInput.addEventListener("change", function(evt) {
                const file = evt.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    let result = e.target.result;
                    
                    if (typeof result === "string") {
                        // Clean PEM headers/footers and whitespace
                        const base64 = result.replace(/-----.*?-----/g, "").replace(/\s+/g, "");
                        try {
                            const binary = atob(base64);
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) {
                                bytes[i] = binary.charCodeAt(i);
                            }
                            document.getElementById(textAreaId).value = arrayBufferToHex(bytes.buffer);
                        } catch (err) {
                            // Modified alert
                            console.error("PEM Decode Error:", err);
                            addLog("Certificate PEM Decode Error", 'error');
                        }
                    } else {
                        // Binary file (DER)
                        document.getElementById(textAreaId).value = arrayBufferToHex(result);
                    }
                };

                // Read as Text if PEM, otherwise ArrayBuffer
                if (file.name.toLowerCase().endsWith(".pem") || file.name.toLowerCase().endsWith(".crt")) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        // --- Wizard Logic ---
        function renderSteps() {
            const container = document.getElementById('wizard-steps');
            container.innerHTML = '';
            STEPS.forEach(s => {
                const div = document.createElement('div');
                div.id = `step-${s.id}`;
                div.className = 'step-item';
                div.innerHTML = `
                    <div class="step-icon">‚óè</div>
                    <div class="step-label">${s.label}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateStep(id, status) {
            const el = document.getElementById(`step-${id}`);
            if (!el) return;
            const icon = el.querySelector('.step-icon');
            el.className = `step-item step-${status}`;
            
            if (status === 'loading') icon.innerHTML = '<div class="spinner"></div>';
            else if (status === 'success') icon.innerHTML = '‚úî';
            else if (status === 'error') icon.innerHTML = '‚úñ';
            else icon.innerHTML = '‚óè';
        }

        function resetSteps() {
            STEPS.forEach(s => updateStep(s.id, 'pending'));
        }

        // --- Helper for Wizard Sequence ---
        function waitEvent(name, timeoutMs) {
            lastEvent = null; // Clear previous
            const start = Date.now();
            return new Promise(resolve => {
                const i = setInterval(() => {
                    if (lastEvent && lastEvent.name === name) {
                        clearInterval(i);
                        // FIX: Return true if data is falsy (null/undefined) but event exists
                        // Only return actual data if it's not null/undefined
                        const data = lastEvent.data;
                        resolve((data === undefined || data === null) ? true : data);
                    }
                    if (Date.now() - start > timeoutMs) {
                        clearInterval(i);
                        // Added Debug logs for timeouts
                        console.warn(`Timeout waiting for event '${name}'. Last event was:`, lastEvent);
                        addLog(`Timeout waiting for '${name}'`, 'warning');
                        resolve(null);
                    }
                }, 100);
            });
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        // Modified base64ToHex to strip headers/whitespaces first (User Mode)
        function base64ToHex(b64) {
            try {
                // Strip PEM headers and whitespace before decoding
                const cleanB64 = b64.replace(/-----.*?-----/g, "").replace(/\s/g,'');
                const raw = atob(cleanB64);
                let result = '';
                for(let i=0; i<raw.length; i++) {
                    const hex = raw.charCodeAt(i).toString(16);
                    result += (hex.length === 2 ? hex : '0' + hex);
                }
                return result.toUpperCase();
            } catch(e) { 
                console.error("Cert Decode Error", e);
                return ""; 
            }
        }

        async function runWizardSequence() {
            if (!configData || !port) return;
            const btn = document.getElementById('btn-run-user');
            btn.disabled = true;
            btn.textContent = "Running Sequence...";
            resetSteps();
            currentVerificationData = { clientName: configData.client || 'Unknown Client', vin: '', sn: '' }; // Reset data for PDF

            try {
                // Determine User Data (List or Manual)
                const vinSelectVal = document.getElementById('vin-select').value;
                let targetVin = "";
                let targetPass = "";

                if (vinSelectVal === 'manual') {
                    targetVin = document.getElementById('manual-vin').value.trim();
                    targetPass = document.getElementById('manual-pass').value.trim();
                    if (!targetVin) {
                        // Modified alert
                        addLog("Please enter a valid VIN for manual configuration.", 'error');
                        throw 'vas'; // Abort early
                    }
                } else {
                    const userObj = configData.user_list[vinSelectVal];
                    targetVin = userObj.vin;
                    targetPass = userObj.password;
                }
                
                currentVerificationData.vin = targetVin; // Store target VIN

                // 1. SN (RETRY 5 TIMES)
                updateStep('sn', 'loading');
                let sn = null;
                for (let i = 0; i < 5; i++) {
                    sendAction('test_can');
                    const res = await waitEvent('sn_read', 2500);
                    if (res && res.sn) { 
                        sn = res.sn; 
                        // Stocke le SN dans les donn√©es de v√©rification pour le PDF
                        currentVerificationData.sn = sn;
                        // Update Display in Right Header
                        document.getElementById('display-sn').textContent = `(SN: ${sn})`;
                        break; 
                    }
                    await wait(1500);
                }
                if (!sn) throw 'sn';
                updateStep('sn', 'success');
                await wait(500);

                // 2. Session (RETRY 5 TIMES)
                updateStep('session', 'loading');
                let sessionOK = false;
                for(let i=0; i<5; i++) {
                    sendAction('start_session');
                    if (await waitEvent('session_ok', 3000)) {
                        sessionOK = true;
                        break;
                    }
                    await wait(1000);
                }
                if (!sessionOK) throw 'session';
                updateStep('session', 'success');
                await wait(500);

                // 3. Security (RETRY 5 TIMES)
                updateStep('security', 'loading');
                let secOK = false;
                for(let i=0; i<5; i++) {
                    sendAction('request_seed');
                    if (await waitEvent('security_ok', 4000)) {
                        secOK = true;
                        break;
                    }
                    await wait(1000);
                }
                if (!secOK) throw 'security';
                updateStep('security', 'success');
                await wait(500);

                // 4. Cert 1
                updateStep('cert1', 'loading');
                sendAction('write_cert1', { data: base64ToHex(configData.v2g_root_certificate) });
                // 20s is safe (user requested > 10s)
                if (!(await waitEvent('write_ok', 20000))) throw 'cert1';
                updateStep('cert1', 'success');
                await wait(500);

                // 5. Cert 2
                updateStep('cert2', 'loading');
                sendAction('write_cert2', { data: base64ToHex(configData.v2icp_root_certificate) });
                // 20s is safe
                if (!(await waitEvent('write_ok', 20000))) throw 'cert2';
                updateStep('cert2', 'success');
                await wait(500);

                // 6. TLS
                updateStep('tls', 'loading');
                sendAction('activate_tls', { enabled: configData.activation_tls });
                // INCREASED TIMEOUT TO 10s (was 3s)
                if (!(await waitEvent('write_ok', 10000))) throw 'tls';
                updateStep('tls', 'success');
                await wait(500);

                // 7. VAS
                updateStep('vas', 'loading');
                const typeVal = (configData.type === 'IPv6') ? 1 : 2;
                sendAction('write_vas', {
                    type: typeVal,
                    url: configData.address,
                    path: configData.path,
                    user: targetVin,
                    pass: targetPass
                });
                // 20s is safe
                if (!(await waitEvent('write_ok', 20000))) throw 'vas';
                updateStep('vas', 'success');
                await wait(2000);

                // 8. Verify
                updateStep('verify', 'loading');
                sendAction('read_config');
                const pTls = waitEvent('tls_read', 5000);
                const pVas = waitEvent('vas_read', 5000);
                const results = await Promise.all([pTls, pVas]);
                
                const readTls = results[0];
                const readVas = results[1];

                if (!readTls || !readVas) throw 'verify';

                // VALIDATION LOGIC: Compare Sent vs Received
                let validationErrors = [];

                // Compare TLS
                if (readTls.active !== configData.activation_tls) {
                    validationErrors.push(`TLS Mismatch: Expected ${configData.activation_tls}, Got ${readTls.active}`);
                }

                // Compare VAS
                if (readVas.type !== typeVal) {
                    validationErrors.push(`VAS Type Mismatch: Expected ${typeVal}, Got ${readVas.type}`);
                }
                if (readVas.url !== configData.address) {
                    validationErrors.push(`URL Mismatch: Expected '${configData.address}', Got '${readVas.url}'`);
                }
                if (readVas.path !== configData.path) {
                    validationErrors.push(`Path Mismatch: Expected '${configData.path}', Got '${readVas.path}'`);
                }
                if (readVas.user !== targetVin) {
                    validationErrors.push(`User Mismatch: Expected '${targetVin}', Got '${readVas.user}'`);
                }
                // Password check (Real Pass from device vs config)
                if (readVas.pass !== targetPass) {
                    validationErrors.push(`Password Mismatch.`);
                }

                if (validationErrors.length > 0) {
                    console.error("Verification Failures:", validationErrors);
                    // Modified alert to custom log/message box
                    addLog("Verification Failed: " + validationErrors.join(", "), 'error');
                    throw 'verify';
                }

                updateStep('verify', 'success');
                
                // Success Modal
                openSuccessModal(results[0], results[1]);

            } catch (stepId) {
                updateStep(stepId, 'error');
                // Error Modal
                openErrorModal(stepId);
            } finally {
                btn.disabled = false;
                btn.textContent = "Install Configuration";
            }
        }

        // --- PDF Generation Logic (Optimized for size) ---
        async function exportPdfReport() {
            // Check if jsPDF is loaded
            if (typeof window.jspdf === 'undefined') {
                addLog("Error: jspdf library not defined.", 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Generate filename logic (Same as before)
            const now = new Date();
            const dateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
            const timeStr = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0');
            const clientName = currentVerificationData.clientName || 'Client';
            const vin = currentVerificationData.vin || 'VIN';
            const filename = `${clientName}_${vin}_${dateStr}_${timeStr}.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_');

            // --- Generate PDF Content (Vector based) ---
            
            // Title
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246); // Primary Blue (#3b82f6)
            doc.text("Final Verification Report", 105, 20, { align: "center" }); // Center title

            // Content Loop (Read from DOM to ensure WYSIWYG without heavy state management)
            const rows = document.querySelectorAll('#verify-content .verify-row');
            let yPosition = 40;
            const leftMargin = 20;
            const rightColumnX = 80;
            
            doc.setFontSize(11);
            
            rows.forEach((row, index) => {
                const label = row.querySelector('.verify-label').textContent.replace(':', '');
                const value = row.querySelector('.verify-val').textContent;

                // Draw Background for alternate rows (optional, keeps it clean)
                if (index % 2 === 0) {
                    doc.setFillColor(245, 247, 250); // Light gray
                    doc.rect(15, yPosition - 6, 180, 10, 'F');
                }

                // Draw Label
                doc.setFont("helvetica", "bold");
                doc.setTextColor(100, 100, 100); // Muted Text
                doc.text(label, leftMargin, yPosition);

                // Draw Value
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0); // Black Text
                
                // Handle text wrapping for long values (URL, Password, VIN)
                const splitValue = doc.splitTextToSize(value, 110); // Wrap at 110mm width
                doc.text(splitValue, rightColumnX, yPosition);

                // Increment Y based on number of lines in value
                yPosition += (8 * splitValue.length) + 2; 
            });

            // Footer (Timestamp)
            const genDate = document.getElementById('generation-date').textContent;
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text(`Generated on: ${genDate}`, 190, 280, { align: "right" });

            // Footer (Signature/Line)
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 275, 190, 275);
            doc.text("VC-VCCU Configurator", 20, 280);

            // Save
            doc.save(filename);
            addLog(`PDF report generated (Vector): ${filename}`, 'success');
        }

        // --- Modals Logic ---
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function openSuccessModal(tls, vas) {
            const content = document.getElementById('verify-content');
            let typeStr = "Unknown";
            if (vas.type === 1) typeStr = "Fixed IPv6";
            else if (vas.type === 2) typeStr = "URL";
            
            // Reading stored SN
            const sn = currentVerificationData.sn || '-';

            // vas.pass contains the real password now that ESP32 FW is patched
            content.innerHTML = `
                <div class="verify-row"><span class="verify-label">Client:</span><span class="verify-val">${currentVerificationData.clientName}</span></div>
                <div class="verify-row"><span class="verify-label">Serial Number (SN):</span><span class="verify-val">${sn}</span></div>
                <div class="verify-row"><span class="verify-label">VIN Used:</span><span class="verify-val">${currentVerificationData.vin}</span></div>
                <div class="verify-row"><span class="verify-label">TLS Active:</span><span class="verify-val">${tls.active ? 'YES' : 'NO'}</span></div>
                <div class="verify-row"><span class="verify-label">VAS Type:</span><span class="verify-val">${typeStr}</span></div>
                <div class="verify-row"><span class="verify-label">URL/IP:</span><span class="verify-val">${vas.url}</span></div>
                <div class="verify-row"><span class="verify-label">Path:</span><span class="verify-val">${vas.path}</span></div>
                <div class="verify-row"><span class="verify-label">User:</span><span class="verify-val">${vas.user}</span></div>
                <div class="verify-row"><span class="verify-label">Password:</span><span class="verify-val">${vas.pass}</span></div>
            `;
            
            // Update generation date for the PDF content
            document.getElementById('generation-date').textContent = new Date().toLocaleString('en-US'); // Use en-US for English formatting
            
            document.getElementById('success-modal').classList.add('show');
        }

        function openErrorModal(stepId) {
            const msg = document.getElementById('error-msg');
            msg.textContent = `The installation stopped at step: ${stepId}`;
            document.getElementById('error-modal').classList.add('show');
        }

        // --- Expert Mode Helpers ---
        function sendExpCert(num) {
            const val = document.getElementById(`exp-c1`).value.trim(); 
            const raw = num === 1 ? document.getElementById('exp-c1').value : document.getElementById('exp-c2').value;
            // Basic hex sanitation
            const hex = raw.replace(/-----.*?-----/g, "").replace(/\s/g, '').toUpperCase();
            if(!hex) {
                 // Modified alert
                console.warn("Empty Certificate Hex");
                addLog("Empty Certificate Hex", 'warning');
                return;
            }
            sendAction(`write_cert${num}`, { data: hex });
        }

        function writeExpVas() {
            sendAction('write_vas', {
                type: parseInt(document.getElementById('exp-vas-type').value),
                url: document.getElementById('exp-vas-url').value,
                path: document.getElementById('exp-vas-path').value,
                user: document.getElementById('exp-vas-user').value,
                pass: document.getElementById('exp-vas-pass').value,
            });
        }
    </script>
</body>
</html>